<?xml version="1.0" encoding="utf-8"?>
<Window>
	<Form Height="216" Id="ogm410_POP" Left="8" OnFocus="menu_OnFocus" OnLoadCompleted="on_LoadCompleted" PidAttrib="7" Title="장비자료복사" TooltipFont="Default,0" Top="8" Ver="1.0" Width="328" WorkArea="true">
		<Image FillType="STRETCH" Font="돋움,9,Bold" Height="28" Id="titleBar" ImageID="main_tit_bak" Left="-2" TabOrder="1" TabStop="FALSE" Width="330"></Image>
		<FileDialog AppendExtDefault="TRUE" Bottom="25" FileNameList="|" Filter="ALL&#32;File(*.*)|*.*" Height="24" Id="FileDialog0" Left="265" Right="289" TabOrder="4" Top="1" Width="24"></FileDialog>
		<File Bottom="25" Height="24" Id="File" Left="289" Right="313" TabOrder="3" Top="1" Width="24"></File>
		<Static BKColor="white" Border="Flat" BorderColor="#b4b4b4" Height="185" Id="searchBar" TabOrder="5" Top="31" Width="328"></Static>
		<Static Border="Flat" BorderColor="white" Font="굴림,9,Bold" Height="20" Id="Static3" Left="17" TabOrder="5" Text="내용을&#32;복사할&#32;관리번호" Top="64" VAlign="Middle" Width="183"></Static>
		<Button Height="26" Id="btn_cpaddclose" ImageID="closeBtn" Left="240" OnClick="btn_cpaddclose_OnClick" TabOrder="2" Text="닫기" Top="144" Width="75"></Button>
		<Button Height="26" Id="btn_cpadd" ImageID="btn2_cp2" Left="240" OnClick="btn_cpadd_OnClick" TabOrder="3" Text="복사" Top="88" Width="75"></Button>
		<Static Border="Flat" BorderColor="white" Font="굴림,9,Bold" Height="20" Id="lblnewmngno" Left="17" TabOrder="7" Text="설비장비의&#32;신규&#32;생성&#32;관리번호" Top="136" VAlign="Middle" Width="207"></Static>
		<Edit Height="20" Id="txtmngno" Left="14" MaxLength="10" OnCharChanged="txtmngno_OnCharChanged" TabOrder="8" Top="89" UpperOnly="TRUE" Width="194"></Edit>
		<Edit Height="20" Id="txtnewmngno" ImeMode="none" Left="14" MaxLength="10" TabOrder="9" Top="161" UpperOnly="TRUE" Width="194"></Edit>
		<Static Color="#333333" Font="돋움,9,Bold" Height="13" Id="title_text" Left="16" TabOrder="4" Top="8" Width="296"></Static>
	</Form>
	<Script><![CDATA[/*--------------------------------------------------------------
 * @@version               : 1.0 
 * @@Revision History      :
 * @@author                : Jae hb
 * @@see
 * ● SYSTEM NAME          : DIONE
 * ● PROGRAM NO.          : ogm200_popxml
 * ● PROGRAM DESCRIPTION  : 작업개시등록 설비조회
 * ● DATE WRITTEN         : 2011.08.25
 ----------------------------------------------------------------*/
#include "script::lib_script_common.js";
#include "script::Grid_Script.js";
#include "script::spare_common.js";
#include "script::fileupdown.js"

var strSeparator = "	";
var Lib1 = G_ds_user.GetColumn(0,"LIB1"); // cigma library(pereslib,psreslib)
var Lib2 = G_ds_user.GetColumn(0,"LIB2"); // 회사 library(psedblib,pscdblib)
var Lib3 = G_ds_user.GetColumn(0,"LIB3"); // 사업부 library(psedblib,pscdblib,pshdblib,pssdblib)
//mngnoPop ==> ogm410에서 보낸 데이터임.
var new_mngno ="";//신규추가관리번호

function on_LoadCompleted(obj){
	getTitle();	
	if(grboption.Value ="3"){
		lblnewmngno.Text="설비장비의 신규 생성 관리번호";
		txtnewmngno.Enable = true;
	}
	else {
		lblnewmngno.Text="새로 생성된 관리번호";	
		txtnewmngno.Enable = false;
	}
	txtmngno.Text = poparray[0];
	txtnewmngno.Text = poparray[1];
}


function btn_cpaddclose_OnClick(obj)
{
	close();
}

function btn_cpadd_OnClick(obj)
{	
	var mno = trim(txtmngno.Text);
	var insFlag = "insert";
	
	var pcomps = "";
	var pgroup = "";
	var pmngno = "";
	var pmname = "";
	var pmaker = "";
	var pmtype = "";
	var pjnbno = "";
	var pipdat = "";
	var pdptcd = "";
	var pgubun = "";
	var pdisyn = "";
	var pdidat = "";
	var pdresn = "";
	var pj_gub = "";
	var pjkind = "";
	var pg_gub = "";
	var pgcycl = "";
	var pgnamt = "";
	var pjspec = "";
	var paccno = "";
	var pcnote = "";
		
	if(length(mno) == 0){
		alert("복사할 관리번호를 입력해주십시요.");
		return false;
	}
	if(getogm410_mngChk(mno)=="FALSE"){
		alert("존재하지 않는 관리번호입니다.");
		return false;
	}
	else {
//alert("복사대상있음");
		pcomps = ds_mngChk.GetColumn(0,"COMPS");
		pgroup = ds_mngChk.GetColumn(0,"GROUP");
		pmngno = ds_mngChk.GetColumn(0,"MNGNO");
		pmname = ds_mngChk.GetColumn(0,"MNAME");
		pmaker = ds_mngChk.GetColumn(0,"MAKER");
		pmtype = ds_mngChk.GetColumn(0,"MTYPE");
		pjnbno = ds_mngChk.GetColumn(0,"JNBNO");
		pipdat = ds_mngChk.GetColumn(0,"IPDAT");
		pdptcd = ds_mngChk.GetColumn(0,"DPTCD");
		pgubun = ds_mngChk.GetColumn(0,"GUBUN");
		pdisyn = ds_mngChk.GetColumn(0,"DISYN");
		pdidat = ds_mngChk.GetColumn(0,"DIDAT");
		pdresn = ds_mngChk.GetColumn(0,"DRESN");
		pj_gub = ds_mngChk.GetColumn(0,"J_GUB");
		pjkind = ds_mngChk.GetColumn(0,"JKIND");
		pg_gub = ds_mngChk.GetColumn(0,"G_GUB");
		pgcycl = ds_mngChk.GetColumn(0,"GCYCL");
		pgnamt = ds_mngChk.GetColumn(0,"GNAMT");
		pjspec = ds_mngChk.GetColumn(0,"JSPEC");
		paccno = ds_mngChk.GetColumn(0,"ACCNO");
		pcnote = ds_mngChk.GetColumn(0,"CNOTE");
	}
	/////////////////////////////////////
	/*입력한 관리번호로 복사레코드를 만든다. */
	////////////////////////////////////
	
	if(grboption.Value =="1"  || grboption.Value =="2") //측정기,검사구인 경우 max넘버로 추가시킴.
	{	
		var headcd = substr(trim(txtmngno.Text),0,3);
		getogm410_maxCnt(headcd);
		
		var auto_no = toString(parseInt(ds_maxCnt.GetColumn(0,"mngno"))+1);
		var digit_num = 5 - length(auto_no);
		if(digit_num > 0)
		{
			for(var i = 0 ; i < digit_num; i++)
			{
				auto_no = "0" + auto_no ;
			}
		}
		
		new_mngno = headcd + auto_no;
//alert(new_mngno);		
	}
	else if(grboption.Value == "3") //설비인 경우 끝자리두개를 잘라서 +1시킴
	{
		var incmngno = txtmngno.Text;
		

		if(length(trim(txtnewmngno.Text)) == 0)
		{
			txtnewmngno.Text = getSulbieNextMngno(incmngno);		
			//alert("설비장비에 대한 신규생성 관리번호를 입력해주세요");
			//return false;
		}
		//신규 관리번호가 있는 번호인지 체크합니다.
		new_mngno = trim(txtnewmngno.Text);
		if (getogm410_mngChk(new_mngno)=="FALSE"){
		}
		else{
			alert(new_mngno+" 관리번호가 존재합니다.");
			insFlag = "update";
			return;
		}
	//기존처리대로 개발진행내역  => 설비인 경우 관리번호 자동추가기능이 없음 관리번호를 입력후 중복여부만 체크했었음.
	/*
		if(length(trim(txtnewmngno.Text)) == 0)
		{
			alert("설비장비에 대한 신규생성 관리번호를 입력해주세요");
			return false;
		}
		//신규 관리번호가 있는 번호인지 체크합니다.
		var new_mngno = trim(txtnewmngno.Text);
		if (getogm410_mngChk(new_mngno)=="FALSE"){
			var insertOrupdate = "insert";
		}
		else{
			alert(new_mngno+" 이 관리번호가 존재합니다.");
			return;
		}
	*/
	}
	
	//등록인 경우만 감안함.
	var prsign="1"; //폐기여부	
	var prpdat = "";
	//var delFalg ="N";
	var pyedat="";
	//var didat="";
	prpdat = addMonth(pipdat,"-"+parseInt(pgcycl)); //(예정교정일-주기)로 가상의 최종교정일을 구한다.
	pyedat = pipdat;
	
			
		var sKind		= "setOgm410_POP";						
		var sMethodName = "service::psogmlib/saveOgm410.do";     // 서버에서 호출 될 Method 명
		var sInDataSet  = "";               //자료 저장 시 보낼 DataSet 명칭
		var sOutDataSet = "";    							     // 조회 후 돌려 받을 DataSet 명칭
		var sArgument   = "";
			sArgument += " LIB2=" + quote(Lib2);
			sArgument += " COMPS=" + quote(pcomps); //사업부
			sArgument += " GROUP=" + quote(pgroup); //교정분야
			sArgument += " MNGNO=" + quote(new_mngno); //관리번호
			sArgument += " DPTCD=" + quote(pdptcd ); 
			sArgument += " MNAME=" + quote(pmname);
			sArgument += " MAKER=" + quote(pmaker); 
			sArgument += " MTYPE=" + quote(pmtype);
			sArgument += " JNBNO=" + quote(pjnbno);
			sArgument += " JKIND=" + quote(pjkind);
			sArgument += " IPDAT=" + quote(pipdat);
			sArgument += " G_GUB=" + quote(pg_gub);
			sArgument += " J_GUB=" + quote(pj_gub);
			sArgument += " GCYCL=" + quote(pgcycl);
			sArgument += " GNAMT=" + quote(pgnamt);
			sArgument += " JSPEC=" + quote(pjspec);
			sArgument += " ACCNO=" + quote(paccno);
			sArgument += " DISYN=" + quote(pdisyn);
			sArgument += " DIDAT=" + quote(pdidat);
			sArgument += " DRESN=" + quote(pdresn);
			sArgument += " CNOTE=" + quote(pcnote);
			sArgument += " ADDAT=" + quote(parseInt(nowDate));
			sArgument += " ADTIM=" + quote(h);
			sArgument += " ADUSR=" + quote(adusr);
			//sArgument += " CHDAT=" + quote(parseInt(nowDate));
			//sArgument += " CHTIM=" + quote(h);
			//sArgument += " CHUSR=" + quote(adusr);
			
			sArgument += " RPDAT=" + quote(prpdat); //(예정교정일-주기)로 가상의 최종교정일을 구한다.
			//sArgument += " REPNO=" + quote(""); //repno 신규이므로 교정번호가 없다.
			sArgument += " RCYCL=" + quote(pgcycl); //gcycl이 rcycle이 된다.
			sArgument += " YEDAT=" + quote(pyedat); //입고일자가 예정일자가 된다.
			sArgument += " RSIGN=" + quote(prsign); //rsign 

			sArgument += " INSFLAG=" + quote(insFlag);
		
		http.Sync = true;
		Transaction(sKind, sMethodName, sInDataSet, sOutDataSet, sArgument, "callback");
		http.Sync = false;
	
}

/********************************************************************** 
 * 내용설명 : Transaction 리턴후 실행 함수
 **********************************************************************/ 
function callback(svcId, rtnCd, rtnMsg){
	// tran 실패
	if(rtnCd<0){
		alert(setPopMessage("1002"));
		setMessage("1002");
	// tran 성공
	}else if(svcId=="setOgm410_POP"){
		alert(setPopMessage("1001"));
		setMessage("1001");
		txtnewmngno.Text=new_mngno;
	}
	
}
function txtmngno_OnCharChanged(obj,strPreText,strPostText)
{
	txtnewmngno.text="";
}
]]></Script>
</Window>