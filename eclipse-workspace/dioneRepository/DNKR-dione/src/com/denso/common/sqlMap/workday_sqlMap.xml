<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
    
<sqlMap namespace="workday">
	<select id="selectWorkDay" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		select 
			SUBSTRING(a.emp_no,0,7) IDNBR
			, case when convert(int, reader) <![CDATA[<]]> 10 then '0' else 'V' end TRF01
			, convert(char(8),a.regdate,112) TRF02
			, convert(char(8),a.regdate,114) TRF03
			, '' TRF04
			, a.reader TRF05
			, case 
				when a.attendcate = '1' then '1' 
				when a.attendcate = '2' then '6'
				else 'E'
		      end TRF06
			, convert(char(8),a.regdate,112) TRF07
			, convert(char(8),a.regdate,114) TRF08
			, '' TRF09	
			, convert(char(8),a.regdate,112) TRF10
		 from dbo.tbl_attendhist a	
		 where convert(char(10),a.regdate,120)= CONVERT(CHAR(10),CONVERT(DATETIME,#YYYYMMDD#),120)	
		 and a.attendcate = '1'	
		 and a.reader <![CDATA[<]]> '013'	
		 and convert(char(8),a.regdate,114) = (select min(convert(char(8),b.regdate,114))	
			                                     from  dbo.tbl_attendhist b	
			                                    Where a.emp_no = b.emp_no	
			                                    and b.attendcate = '1'	
			                                    and b.reader <![CDATA[<]]> '013'	
			                                    and convert(char(10),b.regdate,120)= CONVERT(CHAR(10),CONVERT(DATETIME,#YYYYMMDD#),120))
		UNION ALL
		select 
			SUBSTRING(a.emp_no,0,7) IDNBR
			, case when convert(int, reader) <![CDATA[<]]> 10 then '0' else 'V' end TRF01
			, convert(char(8),a.regdate,112) TRF02
			, convert(char(8),a.regdate,114) TRF03
			, '' TRF04
			, a.reader TRF05
			, case 
				when a.attendcate = '1' then '1' 
				when a.attendcate = '2' then '6'
				else 'E'
		      end TRF06
			, convert(char(8),a.regdate,112) TRF07
			, convert(char(8),a.regdate,114) TRF08
			, '' TRF09	
			, convert(char(8),a.regdate,112) TRF10
		 from dbo.tbl_attendhist a	
		 where convert(char(10),a.regdate,120)= CONVERT(CHAR(10),CONVERT(DATETIME,#YYYYMMDD#),120)	
		 and a.attendcate = '2'	
		 and a.reader <![CDATA[<]]> '013'	
		 and convert(char(8),a.regdate,114) = (select min(convert(char(8),b.regdate,114))	
			                                     from  dbo.tbl_attendhist b	
			                                    Where a.emp_no = b.emp_no	
			                                    and b.attendcate = '2'	
			                                    and b.reader <![CDATA[<]]> '013'	
			                                    and convert(char(10),b.regdate,120)= CONVERT(CHAR(10),CONVERT(DATETIME,#YYYYMMDD#),120))
	</select>
</sqlMap>
