<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.globaldenso.dnkr.integration.dao.PrdPrfByItmNmbDao">

<!-- 検索結果をMapで受け取る -->
    <resultMap id="PrdPrfByItmNmb" type="PrdPrfByItmNmbDomain">
        <result property="clsCode" column="CLS_CODE" />
        <result property="lineCode" column="LINE_CODE" />
        <result property="lineNm" column="LINE_NM" />        
        <result property="prdtNo" column="PRDT_NO" />  
        <result property="prdtNm" column="PRDT_NM" />         
        <result property="locCode" column="LOC_CODE" /> 
        <result property="drctHdcn" column="DRCT_HDCN" /> 
        <result property="indrHdcn" column="INDR_HDCN" /> 
        <result property="jmLabor" column="JM_LABOR" />                                 
        <result property="prfrTime" column="PRFR_TIME" /> 
        <result property="excTmRt" column="EXC_TM_RT" /> 
        <result property="indTmRt" column="IND_TM_RT" /> 
        <result property="excIndRt" column="EXC_IND_RT" /> 
        <result property="mrgFct" column="MRG_FCT" />                  
        <result property="sgmRgsArb" column="SGM_RGS_ARB" />                          
        <result property="stdrLabor" column="STDR_LABOR" />
        <result property="cycleTime" column="CYCLE_TIME" />
        <result property="uph" column="UPH" />        
        <result property="regUser" column="REG_USER" />        
        <result property="regDate" column="REG_DATE" />
        <result property="modUser" column="MOD_USER" />
        <result property="modDate" column="MOD_DATE" />

        <result property="lib1" column="lib1" />
        <result property="lib2" column="lib2" />
        <result property="lib3" column="lib3" /> 

        <result property="oldLineCode" column="OLD_LINE_CODE" />       
        <result property="oldPrdtNo" column="OLD_PRDT_NO" /> 
        
        <result property="year" column="YEAR" />         
        <result property="fsHalf" column="FS_HALF" />         
        <result property="oldYear" column="OLD_YEAR" />         
        <result property="oldFsHalf" column="OLD_FS_HALF" />  
                       
        <result property="resultManHour" column="RESULT_MAN_HOUR" />
        <result property="totalQY" column="TOTAL_QY" />
        <result property="jmBaseTime" column="JM_BASE_TIME" />
        <result property="indexPlan" column="INDEX_PLAN" />
        <result property="indexResult" column="INDEX_RESULT" />
        <result property="prodIndex" column="PROD_INDEX" />

    </resultMap>

    <!-- 検索 SQL文（任意条件） -->
    <select id="searchByCondition" resultMap="PrdPrfByItmNmb" parameterType="PrdPrfByItmNmbDomain">
		
		select 
		
		 	A.line_code,
		 	A.line_nm,
			B.PRDT_NO,
			B.CYCLE_TIME,	--CYCLE TIME
			B.JM_LABOR,	--정미공수
			B.STDR_LABOR,	 --기준공수
			--실적공수(초) 
			C.qy as TOTAL_QY, -- 생산실적
			--B.JM_LABOR * C.QY as TOTAL_QY, -- 정미공수기준시간
			B.STDR_LABOR * C.qy /3600 as JM_BASE_TIME, --기준시간(HR/품번단위생산량실적) 
			D.time_sum - E.m_time as RESULT_MAN_HOUR, -- 실적시간
			CAST(D.time_sum - E.m_time as float) / (B.STDR_LABOR * C.qy /3600) * 100 as INDEX_RESULT, -- 공수저감지수_실적
			'0' as INDEX_PLAN, -- 공수저감지수_목표
			'0' as PROD_INDEX --설총율
		from 
			PSZDBLIB.FHP010PF A, 
			PSZDBLIB.FHP030PF B,
			(select
			loc_code, line_code, product_no, sum(qy) as qy
			from PSZDBLIB.FHP100PF
			where
			substr(opert_de,1,6) = #{repym}
			group by loc_code, line_code, product_no ) C 
			left outer join 			
			(select
			LINE_CODE,
			substr(opert_de,1,6),
			SUM((PRSNL1*HR_MNT1) + (PRSNL2*HR_MNT2) + (PRSNL3*HR_MNT3) + (PRSNL4*HR_MNT4) + 
			(PRSNL5*HR_MNT5) + (PRSNL6*HR_MNT6) + (PRSNL7*HR_MNT7) + (PRSNL8*HR_MNT8)) as time_sum
			from PSZDBLIB.FHP109PF
			where
			substr(opert_de,1,6) = #{repym}
			group by LINE_CODE, substr(opert_de,1,6)) D on C.LINE_CODE = D.LINE_CODE 
			left outer join 			
			(
			select
			line_code,
			substr(opert_de,1,6)
			,
			sum(hr_mnt) m_time
			from PSZDBLIB.FHP130PF
			where
			substr(opert_de,1,6) = #{repym}
			group by line_code, substr(opert_de,1,6) ) E on D.LINE_CODE = E.LINE_CODE 
		where
		A.CLS_CODE = A.CLS_CODE
		AND A.LINE_CODE = B.LINE_CODE
		AND A.LOC_CODE = C.LOC_CODE
		AND A.LINE_CODE = C.LINE_CODE
		AND B.PRDT_NO = C.product_no 
		and A.CLS_CODE = #{clsCode}
		and A.LOC_CODE = #{locCode}
		
    </select>      
    
    <!-- 検索 SQL文（任意条件 件数取得） -->
    <select id="searchCount" resultType="java.lang.Integer" parameterType="PrdPrfByItmNmbDomain">
        SELECT 
              COUNT(*) CNT 
        FROM 
             PSZDBLIB.FHP030PF
        WHERE CLS_CODE = #{clsCode}
		AND   YEAR = #{year}        
		AND   FS_HALF = #{fsHalf}        
		AND   LINE_CODE = '${lineCode}'
		AND   PRDT_NO = '${prdtNo}'	        
    </select>

    <!-- 検索 SQL文（任意条件 件数取得） -->
    <select id="searchCount2" resultType="java.lang.Integer" parameterType="PrdPrfByItmNmbDomain">
        SELECT 
              COUNT(*) CNT 
        FROM 
             PSZDBLIB.FHP030PF
        WHERE CLS_CODE = '${clsCode}'
		AND   YEAR = #{oldYear}        
		AND   FS_HALF = #{oldFsHalf}         
		AND   LINE_CODE = '${oldLineCode}'
		AND   PRDT_NO = '${oldPrdtNo}'		      
    </select>
        
    <!-- 登録 SQL文 -->
    <insert id="create" parameterType ="PrdPrfByItmNmbDomain">
        INSERT INTO  PSZDBLIB.FHP030PF (
				 CLS_CODE
				,LINE_CODE
				,YEAR
				,FS_HALF
				,PRDT_NO
				,LOC_CODE
				,JM_LABOR
				,STDR_LABOR
				,CYCLE_TIME			
				,DRCT_HDCN
				,INDR_HDCN
				,PRFR_TIME
				,EXC_TM_RT
				,IND_TM_RT
				,EXC_IND_RT		
				,REG_USER
				,REG_DATE
        ) values (
                #{clsCode}
               ,#{lineCode}
               ,#{year}
               ,#{fsHalf}                              
               ,#{prdtNo}
               ,#{locCode}               
               ,#{jmLabor} 
               ,#{stdrLabor}                
               ,#{cycleTime}                               
               ,#{drctHdcn}                 
               ,#{indrHdcn}   
               ,#{prfrTime}                   
               ,#{excTmRt}                 
               ,#{indTmRt} 
               ,#{excIndRt}                                                                      
               ,#{regUser}               
               ,REPLACE(CHAR(DATE(CURRENT DATE), ISO), '-','')
        )
    </insert>

	<!-- 更新 SQL文（主キー） -->
    <update id="update" parameterType="PrdPrfByItmNmbDomain">
        UPDATE 
            PSZDBLIB.FHP030PF
        SET
        	 LINE_CODE = #{lineCode}
        	,PRDT_NO = #{prdtNo}        	
			,JM_LABOR = #{jmLabor}
			,STDR_LABOR = #{stdrLabor}
			,CYCLE_TIME = #{cycleTime}
	 		,DRCT_HDCN = #{drctHdcn}
			,INDR_HDCN = #{indrHdcn}
			,PRFR_TIME = #{prfrTime}
			,EXC_TM_RT = #{excTmRt}
			,IND_TM_RT = #{indTmRt}
			,EXC_IND_RT = #{excIndRt}
        	,MOD_USER = #{modUser}
            ,MOD_DATE = REPLACE(CHAR(DATE(CURRENT DATE), ISO), '-','')
        WHERE CLS_CODE = #{clsCode}
		AND   YEAR = #{oldYear}        
		AND   FS_HALF = #{oldFsHalf}          
        AND   LINE_CODE = #{oldLineCode}
        AND   PRDT_NO = #{oldPrdtNo}        
    </update>
    
	<!-- 更新 SQL文（主キー） -->
    <update id="updateTest" parameterType="PrdPrfByItmNmbDomain">
        UPDATE 
            PSZDBLIB.FHP030PF
        SET
        	 LINE_CODE = '${lineCode}'
        	,PRDT_NO = '${prdtNo}'        	
			,JM_LABOR = '${jmLabor}'
			,STDR_LABOR = '${stdrLabor}'
			,CYCLE_TIME = '${cycleTime}'
	 		,DRCT_HDCN = '${drctHdcn}'
			,INDR_HDCN = '${indrHdcn}'
			,PRFR_TIME = '${prfrTime}'
			,EXC_TM_RT = '${excTmRt}'
			,IND_TM_RT = '${indTmRt}'
			,EXC_IND_RT = '${excIndRt}'
        	,MOD_USER = '${modUser}'
            ,MOD_DATE = REPLACE(CHAR(DATE(CURRENT DATE), ISO), '-','')
        WHERE CLS_CODE = '${clsCode}'
		AND   YEAR = '${oldYear}'        
		AND   FS_HALF = '${oldFsHalf}'          
        AND   LINE_CODE = '${oldLineCode}'
        AND   PRDT_NO = '${oldPrdtNo}'        
    </update>    

    <!-- 削除 SQL文（主キー） -->
    <delete id="delete" parameterType="PrdPrfByItmNmbDomain">
        DELETE 
        FROM 
             PSZDBLIB.FHP030PF
        WHERE CLS_CODE = #{clsCode}
		AND   YEAR = #{year}        
		AND   FS_HALF = #{fsHalf}          
        AND   LINE_CODE = #{lineCode}
        AND   PRDT_NO = #{prdtNo}   
    </delete>
    
    

</mapper>