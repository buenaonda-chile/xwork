<?xml version="1.0" encoding="utf-8"?>
<Window>
	<Form Height="144" Id="ogm206_POP" Left="8" OnFocus="menu_OnFocus" OnLoadCompleted="on_LoadCompleted" PidAttrib="7" Title="첨부파일선택" TooltipFont="Default,0" Top="8" Ver="1.0" Width="408" WorkArea="true">
		<Datasets>
			<Dataset DataSetType="Dataset" Id="ds_ogm206_tname">
				<Contents>
					<colinfo id="TNAME" size="256" summ="default" type="STRING"/>
					<record>
						<TNAME>작업부&#32;상세도(삽입그림)</TNAME>
					</record>
					<record>
						<TNAME>장시간고장발생보고서(A링크)</TNAME>
					</record>
					<record>
						<TNAME>이력보고&#32;보충자료</TNAME>
					</record>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_ogm206_maxSeq"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_uploadFile">
				<Contents>
					<colinfo id="chk" size="256" summ="default" type="STRING"/>
					<colinfo id="fullname" size="256" summ="default" type="STRING"/>
					<colinfo id="filename" size="256" summ="default" type="STRING"/>
					<colinfo id="prog_bar" size="256" summ="default" type="STRING"/>
					<colinfo id="filesize" size="256" summ="default" type="INT"/>
					<colinfo id="progsize" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
		</Datasets>
		<Image FillType="STRETCH" Font="돋움,9,Bold" Height="28" Id="titleBar" ImageID="main_tit_bak" Left="-2" TabOrder="1" TabStop="FALSE" Width="410"></Image>
		<Static Color="#333333" Font="돋움,9,Bold" Height="24" Id="title_text" Left="16" TabOrder="5" Width="384"></Static>
		<FileDialog AppendExtDefault="TRUE" Bottom="24" FileNameList="|" Filter="ALL&#32;File(*.*)|*.*" Height="24" Id="FileDialog0" Left="344" Right="368" TabOrder="4" Width="24"></FileDialog>
		<File Bottom="24" Height="24" Id="File" Left="376" Right="400" TabOrder="3" Width="24"></File>
		<Static BKColor="white" Border="Flat" BorderColor="#b4b4b4" Height="113" Id="searchBar" TabOrder="6" Top="31" Width="408"></Static>
		<Combo CodeColumn="TNAME" DataColumn="TNAME" Height="20" Id="cmbSiryo" InnerDataset="ds_ogm206_tname" Left="16" TabOrder="2" Top="92" Width="272"></Combo>
		<Static Align="Center" BKColor="#dfdfdf" Border="Flat" BorderColor="#b4b4b4" Font="굴림,9,Bold" Height="20" Id="Static3" Left="17" TabOrder="7" Text="자료타이틀을&#32;입력해주세요." Top="56" VAlign="Middle" Width="183"></Static>
		<Button Height="26" Id="btn_selclose" ImageID="closeBtn" Left="320" OnClick="btn_selclose_OnClick" TabOrder="3" Text="닫기" Top="48" Width="75"></Button>
		<Button Height="26" Id="btn_seladd" ImageID="btn2_regi2" Left="320" OnClick="btn_seladd_OnClick" TabOrder="4" Text="등록" Top="80" Width="75"></Button>
		<File Bottom="128" Height="24" Id="ProFile" Left="288" Right="312" TabOrder="7" Top="104" Width="24"></File>
		<CyHttpFile Height="24" Id="CyHttpFile0" Left="256" Top="112" Width="24"></CyHttpFile>
	</Form>
	<Script><![CDATA[/*--------------------------------------------------------------
 * @@version               : 1.0 
 * @@Revision History      :
 * @@author                : Jae hb
 * @@see
 * ● SYSTEM NAME          : DIONE
 * ● PROGRAM NO.          : ogm200_popxml
 * ● PROGRAM DESCRIPTION  : 작업개시등록 설비조회
 * ● DATE WRITTEN         : 2011.08.25
 ----------------------------------------------------------------*/
#include "script::lib_script_common.js";
#include "script::Grid_Script.js";
#include "script::spare_common.js";
#include "script::fileupdown.js";

var strSeparator = "	";
var Lib1 = G_ds_user.GetColumn(0,"LIB1"); // cigma library(pereslib,psreslib)
var Lib2 = G_ds_user.GetColumn(0,"LIB2"); // 회사 library(psedblib,pscdblib)
var Lib3 = G_ds_user.GetColumn(0,"LIB3"); // 사업부 library(psedblib,pscdblib,pshdblib,pssdblib)
var company = G_ds_user.GetColumn(0,"COMPANY");
var comps = G_ds_user.GetColumn(0,"PLANT_CD");
var nowDate = today();
var prtcd;
var gImgPath = "/bojen/images/";
var imgUPDOWNpath="C:/Program Files/Apache Software Foundation/Tomcat 6.0/webapps/DIONE_UPDOWN_FILE/bojen/images/";
//var prtnm;

function on_LoadCompleted(obj){
	
}

/********************************************************************** 
 * 내용설명 : Max_seqno
 **********************************************************************/ 
function getogm206_maxSeq(){
	
	var sKind		= "getogm206_maxSeq";						
	var sMethodName = "service::psogmlib/selectOGM206_maxSeq.do"; 
	var sInDataSet  = "";
	var sOutDataSet = "ds_ogm206_maxSeq=ds_ogm206_maxSeq";
	var sArgument   = "";
		sArgument += " LIB2=" + quote(Lib2);
		sArgument += " COMPS=" + quote(ComboBoxPlant.Value); //사업부
	http.Sync = true;
	Transaction(sKind, sMethodName, sInDataSet, sOutDataSet, sArgument, "");
	http.Sync =false;
}

/********************************************************************** 
 * 내용설명 : 첨부파일등록
 **********************************************************************/ 
function setOgm206_sFile(filnm, siryo, seqNo){
	
	var sKind		= "setOgm206_sFile";						
	var sMethodName = "service::psogmlib/saveOGM206_sFile.do"; 
	var sInDataSet  = "";
	var sOutDataSet = "";
	var sArgument   = "";
		sArgument += " LIB2=" + quote(Lib2);
		sArgument += " COMPS=" + quote(ComboBoxPlant.Value); //사업부
		sArgument += " SEQNO=" + quote(seqNo); //seqNo
		sArgument += " JISNO=" + quote(trim(txtjisno2.Text)); //지시No
		sArgument += " FILNM=" + quote(filnm); //filnm
		sArgument += " SIRYO=" + quote(siryo); //siryo
	http.Sync = true;
	Transaction(sKind, sMethodName, sInDataSet, sOutDataSet, sArgument, "callback");
	http.Sync =false;
}

/********************************************************************** 
 * 내용설명 : Transaction 리턴후 실행 함수
 **********************************************************************/ 
function callback(svcId, rtnCd, rtnMsg){
	// tran 실패
	if(rtnCd<0){
		alert(setPopMessage("1002"));
		setMessage("1002");
	// tran 성공	
	//첨부등록
	}else if(svcId=="setOgm206_sFile"){
		alert(setPopMessage("1001"));
		setMessage("1001");
	}
	
}
function btn_seladd_OnClick(obj)
{
	var file_name;
	var blobbuffer;
	getogm206_maxSeq();
	if(length(trim(cmbSiryo.Value)) == 0 ){
		alert(setPopMessage("3057"));
		return;
	}
	
	var max_seqno=trim(ds_ogm206_maxSeq.getcolumn(0,"AUTONUM"));
	var autonum=parseInt(max_seqno)+1;
		
		FileDialog0.FilePath= "C:\\";
		//FileDialog0.Filter = "Image Files(*.*)|*.*|";	
		FileDialog0.Type = "OPEN";
		if(FileDialog0.Open()){
		
			file_name = FileDialog0.FileName;
			var file_path = FileDialog0.FilePath;
			var path = file_path + "\\" + file_name;
			//ProFile.FileName = path;

			var lastdotpos;
			for(var i = 0; i< path.length; i++)	{
					if(path.CharAt(i) == ".")
						lastdotpos = i;
			}
			var	ext = toUpperCase(path.substr(lastdotpos+1,3));
			var cheombfile = trim(txtjisno2.Text)+"_"+autonum+"."+ext;
			var	fileVal=gImgPath+cheombfile;
			
			//var file_size = path;
	
			//데이터셋에 로우 추가
			ds_uploadFile.addRow();
			//다이얼로그에서 선택한 파일의 경로명(파일명포함)을 데이터셋에 저장
			ds_uploadFile.SetColumn(ds_uploadFile.row,"fullname", path);
			//다이얼로그에서 선택한 파일명을 데이터셋에 저장
			ds_uploadFile.SetColumn(ds_uploadFile.row,"filename", cheombfile);
				
			if(!file_Upload()){
				ds_uploadFile.DeleteAll();
				FileDialog0.FileName= "";
				return false;
			}
			else {
				setOgm206_sFile(fileVal, cmbSiryo.Value, autonum);
				FileDialog0.FileName= "";
			}	
		}
		else{
			alert(setPopMessage("3040"));
		}
}


/********************************************************************** 
 * 내용설명 : 파일Upload
 **********************************************************************/ 
/*
function file_Upload(file_name, blobbuffer){

	ds_uploadFile.AddRow();
	ds_uploadFile.SetColumn(0, "FILE_NAME", file_name);
	ds_uploadFile.SetColumn(0, "FILE_BLOB", blobbuffer);

	var sKind		= "file_upload";						
	var sMethodName = "service::psogmlib/fileUpload.do"; 
	var sInDataSet  = "ds_uploadFile=ds_uploadFile:u"; //자료 저장 시 보낼 DataSet 명칭
	var sOutDataSet = "";
	var sArgument   = "";
	http.Sync = true;
	Transaction(sKind, sMethodName, sInDataSet, sOutDataSet, sArgument, "Tran_CallBack");
	http.Sync = false;	
	ds_uploadFile.DeleteAll();
	
}

//-------------------------------------------------------------------------
// Transaction 수행후 결과 처리 (Async)
// Argument : SrvID(ServiceID),ErrorCode(에러코드),ErrorMsg(에러메세지)
//-------------------------------------------------------------------------

function Tran_CallBack(SrvId,ErrorCode,ErrorMsg)
{
	if(ErrorCode < 0) {
		alert("[ " + ErrorCode + " ]\n\n" + ErrorMsg);  // Message Box를 띄운다
		return;  
	}
}
*/
function btn_selclose_OnClick(obj)
{
	close(getOgm206_fFile());
}


//파일 업로드(httpfile 컨포넌트이용)
function file_Upload(obj)
{
	var ret;
	//var isNewRow = 0;
	
	trace("데이터셋 로우 수:" + ds_uploadFile.rowcount);
	
	//파일선택 버튼을 이용해서 선택된 파일이 없는 경우 처리 생략
	if(ds_uploadFile.rowcount != 0){
	
		//데이터셋 로우 수 만큼 루프
		for ( var i = 0 ; i < ds_uploadFile.rowcount ; i++ )
		{
			
			// 풀경로 취득
			var file_url = ds_uploadFile.getColumn(i,"fullname");
			// 파일 사이즈 취득
			file_size = CyHttpFile0.GetFileSizeLocal(file_url);
			trace("파일사이즈" + file_size);
			
			//사이즈 체크(5MB제한)
			if(file_size > 5000000){
				alert("업로드 가능 용량은 5MB입니다. 확인하고 다시 시도해주십시오.");
				return false;
			}
			//로컬에서 선택한 파일명을 취득하여 변수에 설정
			var str_param = ds_uploadFile.getColumn(i,"filename");
			//업로드 할 서버 경로와 파일명
			var str_param_server = imgUPDOWNpath + str_param;
			
			//스크립트 파일의 함수 호출 
			//CyHttpFile0객체(대용량데이터 이동지원 객체), 경로(파일명포함), 파일명
			//ret = gfn_FileWrite(CyHttpFile0,Dataset1.getColumn(i,"fullname"), str_param, i, "prog_bar", grid0);
			//ret = gfn_FileWrite(CyHttpFile0,file_url, str_param_server, i, "prog_bar", grid0);
			ret = gfn_FileWrite(CyHttpFile0,file_url, str_param_server, i, "prog_bar", "");
							
			trace("파일명:" + str_param);
			trace("경로명:" + ds_uploadFile.getColumn(i,"fullname"));
			
			//호출함수 리턴값 처리
			if ( ret[0] == "FAIL" )
			{
				alert(ret[1]);
				break;
			}
		}
	}
	return true;
}
]]></Script>
</Window>