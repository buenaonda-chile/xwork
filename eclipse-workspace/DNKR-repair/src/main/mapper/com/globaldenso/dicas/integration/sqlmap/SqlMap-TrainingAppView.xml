<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.globaldenso.dicas.business.dao.TrainingAppViewDao">

  <resultMap id="codeMap" type="com.globaldenso.dicas.business.dto.TrainingAppViewDto">
		<id property="id" column="ID" javaType="java.lang.Long" />
		<result property="rgstrId" column="RGSTR_ID" javaType="java.lang.Long" />
		<result property="rgstDt" column="RGST_DT" javaType="java.time.LocalDateTime" />
		<result property="updtrId" column="UPDTR_ID" javaType="java.lang.Long" />
		<result property="updtDt" column="UPDT_DT" javaType="java.time.LocalDateTime" />
		<result property="eduNm" column="EDU_NM" javaType="java.lang.String" />
		<result property="eduDt" column="EDU_DT" javaType="java.lang.String" />
		<result property="reprNm" column="REPR_NM" javaType="java.lang.String" />
		<result property="officePw" column="OFFICE_PW" javaType="java.lang.String" />
		
		<result property="rnkCd" column="RNK_CD" javaType="java.lang.String" />
		<result property="traineeNm" column="TRAINEE_NM" javaType="java.lang.String" />
		<result property="officeTel" column="OFFICE_TEL" javaType="java.lang.String" />
		<result property="moblphonNo" column="MOBLPHON_NO" javaType="java.lang.String" />
		<result property="email" column="EMAIL" javaType="java.lang.String" />
  </resultMap>

  <sql id="select_01">
  	select *
  	   from(
	       	select B.EDU_NM
			      ,TO_CHAR(B.EDU_DT, 'YY-MM-DD HH24:MI') AS EDU_DT
			      ,A.OFFICE_PW
			      ,A.REPR_NM
			  from TB_ED_EDUCATION_MASTER A
			  left outer join TB_ED_EDUCATION_INFO B ON B.ID = A.EDU_ITEM
	   ) X
  </sql>
  
  <sql id="select_02">
  	select *
  	   from(
			SELECT B.ID
				  ,B.RNK_CD
				  ,B.TRAINEE_NM
				  ,B.OFFICE_TEL
				  ,B.MOBLPHON_NO
				  ,B.EMAIL
				  ,A.REPR_NM
				  ,A.OFFICE_PW
				  ,C.EDU_NM
	  			  ,TO_CHAR(C.EDU_DT, 'YYYY-MM-DD') AS EDU_DT
			  FROM TB_ED_EDUCATION_MASTER A
			  JOIN TB_ED_EDUCATION_SUB B ON B.APPLY_ID = A.APPLY_ID
			  LEFT OUTER JOIN TB_ED_EDUCATION_INFO C ON C.ID = A.EDU_ITEM
	   ) X
  </sql>

  <sql id="where_01">

	  <if test="criteria.reprNm != null and criteria.reprNm != ''">
		  AND REPR_NM = UPPER(#{criteria.reprNm})
	  </if>
	  
	  <if test="criteria.officePw != null and criteria.officePw != ''">
		  AND OFFICE_PW = #{criteria.officePw}
	  </if>
  </sql>

  <sql id="where_02">
  
	  <if test="criteria.reprNm != null and criteria.reprNm != ''">
		  AND REPR_NM = UPPER(#{criteria.reprNm})
	  </if>
	  
	  <if test="criteria.officePw != null and criteria.officePw != ''">
		  AND OFFICE_PW = #{criteria.officePw}
	  </if>
	  
	  <if test="criteria.eduNm != null and criteria.eduNm != ''">
		  AND EDU_NM = #{criteria.eduNm}
	  </if>
	  
	  <if test="criteria.eduDt != null and criteria.eduDt != ''">
		  AND EDU_DT > TO_CHAR(SYSDATE - 20, 'YYYY-MM-DD')
	  </if>

  </sql>


  <!-- ?? SQL?????? -->
  <select id="searchByKey" resultMap="codeMap" parameterType="com.globaldenso.dicas.business.domain.TrainingAppViewDomain">

    SELECT *
    FROM (
    <include refid="select_01"/>
    <where>
	  <include refid="where_01"/>
    </where>
    ) AA
    WHERE AA.ID = #{id}
	  AND ROWNUM = 1

  </select>

  <select id="searchByCondition" resultMap="codeMap" parameterType="Map">

    SELECT *
    FROM (
         SELECT ROWNUM AS RN, A.*
          FROM (
          <include refid="select_01" />
          <where>
			  <include refid="where_01"/>
          </where>
	      ORDER BY EDU_DT DESC
          ) A

     ) AA

    <if test="pageable != null">
      WHERE RN BETWEEN ((${pageable.pageNumber} - 1) * ${pageable.pageSize}) + 1 AND ${pageable.offset}
    </if>
    ORDER BY RN

  </select>


	<select id="searchBySdCondition" resultMap="codeMap" parameterType="Map">

		SELECT *
		FROM (
		SELECT ROWNUM AS RN, A.*
		FROM (
		<include refid="select_02" />
		<where>
			<include refid="where_02"/>
		</where>
		ORDER BY EDU_DT DESC
		) A

		) AA

		<if test="pageable != null">
			WHERE RN BETWEEN ((${pageable.pageNumber} - 1) * ${pageable.pageSize}) + 1 AND ${pageable.offset}
		</if>
		ORDER BY RN

	</select>

   <select id="searchCount" resultType="int" parameterType="Map">

    SELECT COUNT(EDU_DT) AS CNT
    FROM (
      <include refid="select_01" />
      <where>
        <include refid="where_01"/>
      </where>
     ) AA

  </select>

	<select id="searchSdCount" resultType="int" parameterType="Map">

		SELECT COUNT(ID) AS CNT
		FROM (
		<include refid="select_02" />
		<where>
			<include refid="where_02"/>
		</where>
		) AA

	</select>

  <insert id="create" parameterType="com.globaldenso.dicas.business.domain.TrainingAppViewDomain">

    INSERT INTO TB_ED_EDUCATION_MASTER(
				ID
			   ,RGSTR_ID
			   ,RGST_DT
			   ,UPDTR_ID
			   ,UPDT_DT
			   ,APPLY_ID
			   ,EDU_DIV
			   ,EDU_ITEM
			   ,CUST_NM
			   ,OFFICE_NM
			   ,REPR_NM
			   ,OFFICE_TEL
			   ,TEL_NO
			   ,EMAIL
			   ,OFFICE_PW
			   ,INFO_YN
	   )VALUES(
	   			#{id}
			   ,#{rgstrId}
			   ,#{rgstDt}
			   ,#{updtrId}
			   ,#{updtDt}
			   ,#{id}
			   ,#{eduDiv}
			   ,#{eduItem}
			   ,#{custNm}
			   ,#{officeNm}
			   ,#{reprNm}
			   ,#{officeTel}
			   ,#{telNo}
			   ,#{email}
			   ,#{officePw}
			   ,#{infoYn}
	   )

    <selectKey resultType="long" keyProperty="id" order="BEFORE">
      SELECT SEQ_TB_ED_EDUCATION_MASTER.NEXTVAL FROM DUAL
    </selectKey>

  </insert>
  
  <insert id="create2" parameterType="com.globaldenso.dicas.business.domain.TrainingAppViewDomain">

    INSERT INTO TB_ED_EDUCATION_SUB(
			 ID
			,RGSTR_ID
			,RGST_DT
			,UPDTR_ID
			,UPDT_DT
			,APPLY_ID
			,RNK_CD
			,TRAINEE_NM
			,OFFICE_TEL
			,MOBLPHON_NO
			,EMAIL
	   )VALUES(
			 #{id}
			,#{rgstrId}
			,#{rgstDt}
			,#{updtrId}
			,#{updtDt}
			,#{applyId}
			,#{rnkCd}
			,#{traineeNm}
			,#{officeTel}
			,#{moblphonNo}
			,#{email}
	   )

    <selectKey resultType="long" keyProperty="id" order="BEFORE">
      SELECT SEQ_TB_ED_EDUCATION_SUB.NEXTVAL FROM DUAL
    </selectKey>

  </insert>

  <update id="update" parameterType="com.globaldenso.dicas.business.domain.TrainingAppViewDomain">

     UPDATE TB_ED_EDUCATION_SUB
    	SET RNK_CD = #{rnkCd}
		   ,TRAINEE_NM = #{traineeNm}
		   ,OFFICE_TEL = #{officeTel}
		   ,MOBLPHON_NO = #{moblphonNo}
		   ,EMAIL = #{email}
	  WHERE ID = #{id}

  </update>

  <delete id="delete" parameterType="com.globaldenso.dicas.business.domain.TrainingAppViewDomain">

    DELETE FROM TB_ED_EDUCATION_SUB
    WHERE ID = #{id}

  </delete>


</mapper>
